<div class="table-container">
  <table
    class="table-results"
    *ngIf="stagesWithContent.length > 0 && types.length > 0"
  >
    <thead>
      <tr>
        <th
          *ngFor="let stage of stagesWithContent"
          [attr.colspan]="types.length"
          class="left-border right-border stage-header"
          [ngClass]="{
            'highlight-column': stage.id === currentStageId,
            'highlight-stage-header': stage.id === currentStageId
          }"
        >
          <div class="stage-header-wrapper">
            <div
              *ngIf="stage.id === currentStageId"
              class="arrow-icon"
              aria-hidden="true"
            >
              ⬇
            </div>
            <span>{{ stage.number }} - {{ stage.description }}</span>
          </div>
        </th>
      </tr>
      <tr>
        <ng-container *ngFor="let stage of stagesWithContent">
          <th
            *ngFor="let type of types; let j = index"
            [ngClass]="{
              'left-border': j === 0,
              'right-border': j === types.length - 1,
              'highlight-column': stage.id === currentStageId
            }"
          >
            {{ type }}
          </th> 
        </ng-container>
      </tr>
    </thead>

    <tbody>
      <tr>
        <ng-container *ngFor="let stage of stagesWithContent">
          <td
            *ngFor="let type of types; let j = index"
            [ngClass]="{
              'left-border': j === 0,
              'right-border': j === types.length - 1,
              'highlight-column': stage.id === currentStageId
            }"
          >
            <ng-container
              *ngIf="hasAssessments(type, stage.id); else emptyCell"
            >
            <div
              *ngFor="let a of groupedAssessments[type][stage.id]; let last = last"
              class="assessment-entry"
              [ngClass]="{ 'bordered-entry': !last }"
              (click)="evaluationClicked.emit(a)" 
            >
              <button
                class="delete-button"
                (click)="onDeleteClick(a); $event.stopPropagation()"
                title="Eliminar evaluación"
              >
                <span class="material-icons">delete</span>
              </button>

              <div class="entry-date">
                {{ a.createdAt | date: 'dd/MM/yy' }}
              </div>
              <div>
                Nota:
                <span
                  [ngClass]="{
                    'max-point-reached': isMaxReached(a.points),
                    'below-threshold': isBelowMax(a.points)
                  }"
                >
                  {{ a.points }}
                </span>
              </div>
            </div>
            </ng-container>
            <ng-template #emptyCell>
              <span style="color: #ccc">-</span>
            </ng-template>
          </td>
        </ng-container>
      </tr>
    </tbody>
  </table>
</div>
