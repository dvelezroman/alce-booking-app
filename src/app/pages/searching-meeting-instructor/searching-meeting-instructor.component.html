<section class="section">
  <div class="container">

    <div class="block title-container">
      <h1 class="title">Buscar Meetings</h1>
    </div>

   <!-- Dropdown para mostrar u ocultar el formulario -->
    <div class="dropdown-toggle-container">
      <div class="dropdown-toggle" (click)="showForm = !showForm">
        <span>Formulario de Búsqueda</span>
        <span class="icon is-small">
          <i class="material-icons">{{ showForm ? 'expand_less' : 'expand_more' }}</i>
        </span>
      </div>

      <div [ngClass]="showForm ? 'dropdown-body' : 'dropdown-body-hidden'">

        <div class="block-search">
          <form>
            <div class="columns is-mobile">
              <div class="column">
                <div class="field">
                  <label class="label">Fecha desde</label>
                  <div class="control input-date-container">
                    <input class="input" type="date" [(ngModel)]="filter.from" name="from" (ngModelChange)="onFilterChange()">
                    <span class="icon-calendar material-icons">calendar_today</span>
                  </div>
                </div>
              </div>
              <div class="column">
                <div class="field">
                  <label class="label">Fecha hasta</label>
                  <div class="control input-date-container">
                    <input class="input" type="date" [(ngModel)]="filter.to" name="to" (ngModelChange)="onFilterChange()">
                    <span class="icon-calendar material-icons">calendar_today</span>
                  </div>
                </div>
              </div>
            </div>

            <div class="columns is-mobile">
              <div class="column">
                <div class="field">
                  <label class="label">Stage</label>
                  <div class="control">
                    <div class="select is-fullwidth">
                      <select [(ngModel)]="filter.stageId" name="stageId" (ngModelChange)="onFilterChange()">
                        <option value="">Seleccionar stage</option>
                        <option *ngFor="let stage of stages" [value]="stage.id">{{ stage.description }}</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>

              <div class="column">
                <div class="field">
                  <label class="label">Hora</label>
                  <div class="control">
                    <div class="select is-fullwidth">
                      <select [(ngModel)]="filter.hour" name="hour" (ngModelChange)="onFilterChange()">
                        <option value="">Todas las horas</option>
                        <option *ngFor="let hour of availableHours" [value]="hour">{{ hour }}:00</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="field">
              <label class="label">Categoría</label>
              <div class="control">
                <div class="select is-fullwidth">
                  <select [(ngModel)]="filter.category" name="category" (ngModelChange)="onFilterChange()">
                    <option [ngValue]="undefined">Todas las categorías</option>
                    <option *ngFor="let category of ageGroupOptions" [value]="category">{{ category }}</option>
                  </select>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Botón de Crear Meeting -->
    <div class="field has-text-centered my-4" *ngIf="filter.from && filter.hour">
      <button class="button is-link is-mediun" type="button" (click)="onCreateMeeting()">
        + Crear meeting
      </button>
    </div>

      <!-- Formulario de Selección de Contenido -->
    <div *ngIf="meetings.length > 0" class="content-selection-wrapper">
      <!-- Formulario de Selección -->
      <div class="content-selector-card">
        <h2 class="titles has-text-weight-bold">Contenido para la Clase</h2>
        <app-content-selector
          [stages]="stages"
          (contentIdsSelected)="onContentIdsSelected($event)">
        </app-content-selector>
      </div>

      <!-- Mostrar solo si hay contenidos -->
      <ng-container *ngIf="studyContentIds.length > 0">
        <div class="content-summary-box has-text-dark">
          <button class="delete" (click)="clearSelectedContents()"></button>
          <h4>Contenidos listos:</h4>
          <ul>
            <li *ngFor="let content of studyContentOptions">{{ content.name }}</li>
          </ul>
        </div>
      </ng-container>
    </div>

    <div class="block-results">
      <p *ngIf="filter.from && filter.to && meetings && meetings.length === 0" class="no-results-message">
        No hay meetings para el rango asignado.
      </p>

      <app-meeting-table
        [meetings]="meetings"
        [isToday]="isToday.bind(this)"
        [hasMeetingPassed]="hasMeetingPassed.bind(this)"
        [formatStudyContent]="formatStudyContent.bind(this)"
        (contentViewRequested)="showContentViewer($event)"
        (studentContentHistoryRequested)="loadStudentContentHistory($event)"
        (assistanceCheckboxClicked)="onAssistanceCheckboxClick($event.event, $event.meeting)"
      ></app-meeting-table>
    </div>
  </div>
</section>

<app-student-content-history-modal
  *ngIf="isStudentContentHistoryModalVisible"
  [history]="studentContentHistory"
  [stageContents]="studentStageContents"
  [instructorName]="selectedMeeting?.instructor?.user?.firstName + ' ' + selectedMeeting?.instructor?.user?.lastName"
  [stageDescription]="selectedMeeting?.stage?.description"
  (previousStage)="goToPreviousStage()"
  (nextStage)="goToNextStage()"
  [show]="isStudentContentHistoryModalVisible"
  (close)="closeStudentContentHistoryModal()"
></app-student-content-history-modal>

<app-create-meeting-modal
  *ngIf="showCreateModal"
  [fromDate]="filter.from"
  [hour]="filter.hour"
  [instructorId]="instructorId ?? undefined"
  (close)="showCreateModal = false"
  (meetingCreated)="handleMeetingCreated($event)"
></app-create-meeting-modal>

<app-modal
  [showModal]="modal.show"
  [message]="modal.message"
  [isError]="modal.isError"
  [isSuccess]="modal.isSuccess"
  [isInfo]="modal.isInfo"
  [title]="modal.title || ''"
  [isContentViewer]="modal.isContentViewer ?? false"
  (close)="closeModal()"
></app-modal>

<app-modal
  [showModal]="confirmationModal.show"
  [message]="confirmationModal.message"
  [isInfo]="true"
  [isError]="false"
  [showButtons]="confirmationModal.showButtons ?? false"
  (confirmAction)="confirmationModal.confirm && confirmationModal.confirm()"
  (close)="confirmationModal.close()"
/>
