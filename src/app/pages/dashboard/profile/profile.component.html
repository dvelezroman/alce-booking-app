<section class="section">
  <div class="content">
    <!-- Cabecera -->
    <h1 class="reports-progress-header reports-progress-title">
      Perfil de Usuario
    </h1>

    <!-- Card con datos -->
    <div class="profile-card" *ngIf="userData$ | async as user">
      <div class="profile-header">
        <div class="avatar">
          {{ user.firstName?.[0] || '?' }}{{ user.lastName?.[0] || '' }}
        </div>
        <div class="user-info">
          <h2>{{ user.firstName }} {{ user.lastName }}</h2>
          <p class="role">{{ user.role }}</p>
          <p class="email">{{ user.emailAddress || user.email }}</p>
        </div>
      </div>

      <div class="profile-details">
        <p><strong>Contacto:</strong> {{ user.contact || "No especificado" }}</p>
        <p><strong>País:</strong> {{ user.country || "No especificado" }}</p>
        <p><strong>Ciudad:</strong> {{ user.city || "No especificado" }}</p>
        <p>
          <strong>Cumpleaños:</strong>
          {{ user?.birthday ? formatBirthday(user.birthday) : "No registrado" }}
        </p>
        <p><strong>Estado:</strong> {{ user.status || "Activo" }}</p>
        <p><strong>Comentario:</strong> {{ user.comment || "Ninguno" }}</p>
        <p>
          <strong>Datos completados:</strong>
          {{ user.dataCompleted ? "Sí" : "No" }}
        </p>

        <!-- Tutor info (solo si existe y el usuario es STUDENT) -->
        <div *ngIf="user.role === 'STUDENT' && user.student && (user.student.tutorName || user.student.tutorEmail || user.student.tutorPhone)" class="tutor-info">
          <h3 class="mt-4 mb-2"><strong>Información del Tutor</strong></h3>
          <p *ngIf="user.student.tutorName">
            <strong>Nombre:</strong> {{ user.student.tutorName }}
          </p>
          <p *ngIf="user.student.tutorEmail">
            <strong>Email:</strong> {{ user.student.tutorEmail }}
          </p>
          <p *ngIf="user.student.tutorPhone">
            <strong>Teléfono:</strong> {{ user.student.tutorPhone }}
          </p>
        </div>

        <!-- Campo de contraseña -->
        <div class="password-change">
          <label for="password">Cambiar contraseña</label>
          <div class="password-wrapper">
            <input
              id="password"
              [type]="showPassword ? 'text' : 'password'"
              class="password-input"
              [(ngModel)]="newPassword"
              placeholder="Introduce la nueva contraseña"
            />

            <!-- Ícono visible solo si el usuario escribe -->
            <button
              *ngIf="newPassword.trim().length > 0"
              class="btn-eye"
              type="button"
              (click)="togglePasswordVisibility()"
            >
              <i [ngClass]="showPassword ? 'fa fa-eye-slash' : 'fa fa-eye'"></i>
            </button>

            <!-- Botón 'Guardar' solo si la contraseña tiene 6+ caracteres -->
            <button
              *ngIf="newPassword.trim().length >= 6"
              class="btn-change"
              (click)="togglePasswordEdit()"
            >
              Cambiar
            </button>
          </div>

          <!--  Mensaje de error si es menor a 6 caracteres -->
          <p
            *ngIf="newPassword.trim().length > 0 && newPassword.trim().length < 6"
            class="password-error"
          >
            La contraseña debe tener al menos 6 caracteres.
          </p>
        </div>
      </div>

      <!-- Botón para editar -->
      <div class="profile-actions">
        <button class="edit-btn" (click)="openEditForm()">
          {{
            user.dataCompleted ? "Editar información" : "Completar información"
          }}
        </button>
      </div>
    </div>

    <!-- Modal con formulario de edición -->
    <app-users-info-form
      *ngIf="showUserInfoForm"
      [isModalOpen]="true"
      [dataCompleted]="dataCompleted"
      [userData]="user" 
      [tutors]="tutors"
      (formSubmit)="handleUserInfoSubmit($event)"
      (closeModal)="showUserInfoForm = false" >
    </app-users-info-form>

    <!-- Modal de feedback -->
    <app-modal
      [showModal]="modal.show"
      [message]="modal.message"
      [isError]="modal.isError"
      [isSuccess]="modal.isSuccess"
      [title]="modal.title || ''"
      (close)="modal.close()"
    >
    </app-modal>
  </div>
</section>