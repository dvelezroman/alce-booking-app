<section class="section">
  <div class="content">
    <h1 class="reports-progress-header reports-progress-title">
      Perfil de Usuario
    </h1>

    <div class="profile-card" *ngIf="userData$ | async as user">
      <!-- üß© Cabecera -->
      <div class="profile-header">
        <div class="avatar">
          {{ user.firstName?.[0] || '?' }}{{ user.lastName?.[0] || '' }}
        </div>
        <div class="user-info">
          <h2>{{ user.firstName }} {{ user.lastName }}</h2>
          <p class="role">{{ user.role }}</p>
          <p class="email">{{ user.emailAddress || user.email }}</p>
        </div>
      </div>

       <!-- Datos Personales -->
      <div class="profile-details personal-block">
        <div class="block-header">
          <h3>Datos Personales</h3>
        </div>

        <div class="block-content">
          <p><strong>Contacto:</strong> {{ user.contact || "No especificado" }}</p>
          <p><strong>Pa√≠s:</strong> {{ user.country || "No especificado" }}</p>
          <p><strong>Ciudad:</strong> {{ user.city || "No especificado" }}</p>
          <p>
            <strong>Cumplea√±os:</strong>
            {{ user?.birthday ? formatBirthday(user.birthday) : "No registrado" }}
          </p>
        </div>
      </div>

      <!-- Datos Acad√©micos -->
      <div class="profile-details institution-block">
        <div class="block-header">
          <h3>Datos Acad√©micos</h3>
        </div>

        <div class="block-content">
          <p *ngIf="user.occupation">
            <strong>Ocupaci√≥n:</strong> {{ user.occupation }}
          </p>

          <p *ngIf="user.role === 'STUDENT' && user.student?.stage">
            <strong>Etapa:</strong>
            {{ user.student?.stage?.number || user.student?.stage?.description }}
          </p>

          <p *ngIf="user.status"><strong>Estado:</strong> {{ user.status }}</p>
          <p *ngIf="user.comment"><strong>Comentario:</strong> {{ user.comment }}</p>
          <p *ngIf="user.dataCompleted !== undefined">
            <strong>Datos completados:</strong>
            {{ user.dataCompleted ? "S√≠" : "No" }}
          </p>

          <div class="dates-column">
            <p *ngIf="user.role === 'STUDENT' && user.student?.createdAt">
              <strong>Creado:</strong>
              {{ user.student?.createdAt | date: 'dd/MM/yyyy HH:mm' }}
            </p>
            <p *ngIf="user.role !== 'STUDENT' && user.createdAt">
              <strong>Creado:</strong>
              {{ user.createdAt | date: 'dd/MM/yyyy HH:mm' }}
            </p>

            <p *ngIf="user.role === 'STUDENT' && user.student?.updatedAt">
              <strong>Actualizado:</strong>
              {{ user.student?.updatedAt | date: 'dd/MM/yyyy HH:mm' }}
            </p>
            <p *ngIf="user.role !== 'STUDENT' && user.updatedAt">
              <strong>Actualizado:</strong>
              {{ user.updatedAt | date: 'dd/MM/yyyy HH:mm' }}
            </p>
          </div>
        </div>
      </div>

      <!--  Bloque de datos del representante -->
      <div
        *ngIf="
          user.role === 'STUDENT' &&
          user.student &&
          (user.student.tutorName || user.student.tutorEmail || user.student.tutorPhone)
        "
        class="representative-block"
      >
        <div class="block-header">
          <h3>Informaci√≥n del Representante</h3>
        </div>

        <div class="block-content">
          <p *ngIf="user.student.tutorName">
            <strong>Nombre:</strong> {{ user.student.tutorName }}
          </p>
          <p *ngIf="user.student.tutorEmail">
            <strong>Email:</strong> {{ user.student.tutorEmail }}
          </p>
          <p *ngIf="user.student.tutorPhone">
            <strong>Tel√©fono:</strong> {{ user.student.tutorPhone }}
          </p>
        </div>
      </div>

      <!-- üîí Contrase√±a -->
      <div class="password-change">
        <label for="password">Cambiar contrase√±a</label>
        <div class="password-wrapper">
          <input
            id="password"
            [type]="showPassword ? 'text' : 'password'"
            class="password-input"
            [(ngModel)]="newPassword"
            placeholder="Introduce la nueva contrase√±a"
          />

          <button
            *ngIf="newPassword.trim().length > 0"
            class="btn-eye"
            type="button"
            (click)="togglePasswordVisibility()"
          >
            <i [ngClass]="showPassword ? 'fa fa-eye-slash' : 'fa fa-eye'"></i>
          </button>

          <button
            *ngIf="newPassword.trim().length >= 6"
            class="btn-change"
            (click)="togglePasswordEdit()"
          >
            Cambiar
          </button>
        </div>

        <p
          *ngIf="newPassword.trim().length > 0 && newPassword.trim().length < 6"
          class="password-error"
        >
          La contrase√±a debe tener al menos 6 caracteres.
        </p>
      </div>

      <!-- üéõ Bot√≥n para editar -->
      <div class="profile-actions">
        <button class="edit-btn" (click)="openEditForm()">
          {{ user.dataCompleted ? "Editar informaci√≥n" : "Completar informaci√≥n" }}
        </button>
      </div>
    </div>
    <!-- Modal con formulario de edici√≥n -->
        <app-users-info-form
          *ngIf="showUserInfoForm"
          [isModalOpen]="true"
          [dataCompleted]="dataCompleted"
          [userData]="user" 
          (formSubmit)="handleUserInfoSubmit($event)"
          (closeModal)="showUserInfoForm = false" >
        </app-users-info-form>
    
        <!-- Modal de feedback -->
        <app-modal
          [showModal]="modal.show"
          [message]="modal.message"
          [isError]="modal.isError"
          [isSuccess]="modal.isSuccess"
          [title]="modal.title || ''"
          (close)="modal.close()"
        >
        </app-modal>
  </div>
</section>

