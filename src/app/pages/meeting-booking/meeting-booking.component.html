<div class="class-booking-header">
  <h1 class="title is-3">Book your classes</h1>
</div>

<main class="booking-container container">
  <div class="columns is-mobile">
    <section class="column student-info">
      <div class="student-name">
        <h3 *ngIf="userData?.firstName && userData?.lastName">
          {{ userName() }}
        </h3>
        <h3 *ngIf="!userData?.firstName || !userData?.lastName">
          <a [routerLink]="['/register-complete']" class="complete-link">
            Completar Datos
          </a>
        </h3>
      </div>
      <div class="student-details">
        <p>{{ userData?.email }}</p>
      </div>
      <div class="student-detail">
        <p>{{ userData?.stage?.description }}</p>
      </div>

      <!-- Selected Meetings Section -->
      <div class="student-schedule" *ngIf="meetings.length > 0">
        <h4 class="schedule-title">Horario Seleccionado</h4>
        <div class="scroll-buttons">
          <button class="scroll-button left" (click)="scrollLeft()" [class.hidden]="!canScrollLeft" aria-label="Scroll left">
            <i class="fas fa-chevron-left"></i>
          </button>
          <button class="scroll-button right" (click)="scrollRight()" [class.hidden]="!canScrollRight" aria-label="Scroll right">
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>

        <div class="schedule-list" #scheduleList>
          <div *ngFor="let meeting of meetings; let i = index" class="schedule-item" (click)="openMeetingDetailModal(meeting, i)">
            <div class="meeting-title">
              <strong>Meeting {{ i + 1 }}</strong>
            </div>
            <div class="meeting-info-container">
              <div class="schedule-info">
                <strong>Date: </strong> <span>{{ meeting.date | date: 'mediumDate':'UTC' }}</span><br>
                <strong>time: </strong> <span>{{ meeting.hour | number: '2.0' }}:00</span>
              </div>
              <div class="schedule-delete">
                <button class="delete-button" (click)="openDeleteModal(meeting); $event.stopPropagation()">
                  <i class="fas fa-trash-alt"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- No Meetings Message -->
      <div class="no-meeting" *ngIf="meetings.length === 0">
        <p>No tienes fechas de clases programadas</p>
        <i class="far fa-calendar-times no-meeting-icon"></i>
      </div>
    </section>
  </div>

  <!-- Date and Time Selection Section -->
  <div class="date-time-wrapper">

    <!-- Calendar Selection -->
    <section class="date-time-selection">
      <div class="calendar-title">
        <h3 class="title is-4">Select a date</h3>
      </div>
      <div class="month-selector">
        <button *ngIf="canGoBack" class="button is-small prev-button" (click)="prevMonth()" aria-label="Previous month">
          <i class="fas fa-chevron-left"></i>
        </button>
        <span class="month-label">{{ selectedMonth }} {{ selectedYear }}</span>
        <button *ngIf="canGoForward" class="button is-small next-button" (click)="nextMonth()" aria-label="Next month">
          <i class="fas fa-chevron-right"></i>
        </button>
      </div>
      <div class="calendar">
        <div class="calendar-header">
          <div class="calendar-day-header">Sun</div>
          <div class="calendar-day-header">Mon</div>
          <div class="calendar-day-header">Tue</div>
          <div class="calendar-day-header">Wed</div>
          <div class="calendar-day-header">Thu</div>
          <div class="calendar-day-header">Fri</div>
          <div class="calendar-day-header">Sat</div>
        </div>
        <div class="calendar-grid">
          <div
            *ngFor="let day of currentMonthDays"
            class="calendar-day"
            (click)="isDaySelectable(day) ? selectDay(day) : null"
            [class.selected]="selectedDay === day.day"
            [class.selectable]="isDaySelectable(day)"
            [class.unselectable]="!isDaySelectable(day)">
            {{ day.day }}
          </div>
        </div>
      </div>
    </section>

    <!-- Time Slots Selection -->
    <section class="selected-date-time">
      <h2 class="titulo-slots">Select a time</h2>
      <h3 class="title is-3"></h3>
      <button class="scroll-arrow-up" (click)="scrollUp()" [class.disabled]="!canScrollUp" aria-label="Scroll up">
        <i class="fas fa-chevron-up"></i>
      </button>
      <div class="time-slots" #timeSlotList>
        <div *ngFor="let time of timeSlots; let i = index"
             class="time-slot"
             (mouseenter)="hoverIndex = i"
             (mouseleave)="hoverIndex = null">
          <div class="time-text-container">
            <span class="time-text">{{ time.label }}</span>
          </div>
          <div class="confirm-box" *ngIf="hoverIndex === i" (click)="selectTimeSlot(time)">
            Confirm
          </div>
        </div>
      </div>
      <button class="scroll-arrow-down" (click)="scrollDown()" [class.disabled]="!canScrollDown" aria-label="Scroll down">
        <i class="fas fa-chevron-down"></i>
      </button>
    </section>
  </div>
</main>



<!-- Modal de detalles de la reunión -->
<div class="modal" [ngClass]="{ 'is-active': isMeetingDetailModalActive }">
  <div class="modal-background" (click)="closeMeetingDetailModal()"></div>
  <div class="modal-card meeting-detail-modal">
    <header class="modal-card-head">
      <p class="modal-card-title">Detalles Meeting {{ selectedMeetingIndex + 1 }}</p>
    </header>
    <section class="modal-card-body">
      <p><strong>Fecha:</strong> <span>{{ selectedMeeting?.date | date: 'mediumDate' }}</span></p>
      <p><strong>Hora:</strong> <span>{{ selectedMeeting?.hour }}:00</span></p>
      <p><strong>Modo:</strong> <span>{{ selectedMeeting?.mode === mode.ONLINE ? 'Online' : 'Presencial' }}</span></p>
      <p>
        <strong>Instructor:</strong>
        <span>
          {{ (selectedMeeting?.instructor?.user?.firstName || 'Instructor no asignado') | titlecase }}
          {{ selectedMeeting?.instructor?.user?.lastName | titlecase }}
        </span>
      </p>
      <ng-container *ngIf="selectedMeeting?.mode === mode.ONLINE">
        <p class="meeting-link" [ngClass]="{'no-link': !selectedMeeting?.link, 'active': linkStatus === 'active'}">
          <a *ngIf="selectedMeeting?.link"
             [href]="getFormattedLink(selectedMeeting?.link || '')"
             target="_blank" 
             rel="noopener noreferrer">
              {{ selectedMeeting?.link }}
          </a>
          <span *ngIf="!selectedMeeting?.link">Enlace no disponible</span>
        </p>
      </ng-container>
    </section>
  </div>
</div>

<!-- Modal de error -->
<div *ngIf="showModal" class="modal-overlay">
  <div class="modal-content error-modal">
    <i class="fas fa-exclamation-circle error-icon"></i>
    <p class="help is-danger bold-text">You must select a date</p>
    <p class="help is-danger small-text">before choosing a time slot.</p>
  </div>
</div>

<!-- Modal de error por meeting repetida -->
<div *ngIf="showModalBookingError" class="modal-overlay booking-error-modal">
  <div class="modal-content booking-error-content">
    <i class="fas fa-exclamation-circle error-icon"></i>
    <p class="help is-danger bold-text">
      Ya tienes una meeting agendada en la fecha y hora seleccionada.
    </p>
  </div>
</div>

<!-- Modal de error que no tiene asignado stage -->
<div *ngIf="showModalStageError" class="modal-overlay booking-error-modal">
  <div class="modal-content booking-error-content">
    <i class="fas fa-exclamation-circle error-icon"></i>
    <p class="help is-danger bold-text">
      No puedes agendar clases.
      Aun no tienes asignado un Stage, comunicate con administración.
    </p>
  </div>
</div>

<!-- Modal exitoso con botones para confirmar o cancelar -->
<div *ngIf="showSuccessModal" class="modal-overlay">
  <div class="modal-content success-modal">
    <i class="fas fa-question-circle question-icon"></i>
    <p>You have selected <br> {{ selectedDayFormatted }} at {{ selectedTimeSlot.label }}</p>

     <!-- bloque radio buttons -->
    <p class="radio-question">Elige modo de la clase:</p>

    <div class="radio-options">
      <label class="custom-radio">
        <input type="radio" name="meetingType" [(ngModel)]="meetingType" [value]="mode.ONLINE" checked>
        <span class="radio-label">Online</span>
      </label>
      <label class="custom-radio">
        <input type="radio" name="meetingType" [(ngModel)]="meetingType" [value]="mode.PRESENCIAL">
        <span class="radio-label">Presencial</span>
      </label>
    </div>

    <!-- Confirmation and cancellation buttons -->
    <div class="modal-buttons">
      <button class="button is-success" (click)="bookMeeting()">Accept</button>
      <button class="button is-danger" (click)="cancelSelection()">Cancel</button>
    </div>
  </div>
</div>


<!-- Modal de successful-->
<div *ngIf="showInfoModal" class="modal-overlay">
  <div class="modal-content info-modal">
    <i class="fas fa-check-circle info-icon"></i>
    <p>Your selection was successful!</p>
  </div>
</div>


<!-- Modal de confirmación para eliminar meeting-->
<div class="modal" [ngClass]="{ 'is-active': isDeleteModalActive }">
  <div class="modal-background"></div>
  <div class="modal-card">
    <section class="modal-card-body">
      <p>¿Estás seguro de que deseas eliminar esta reunión?</p>
    </section>
    <footer class="modal-card-foot">
      <button class="button is-primary3" (click)="closeDeleteModal()">Cancelar</button>
      <button class="button is-danger2" (click)="confirmDelete()">Eliminar</button>
    </footer>
  </div>
</div>
