<div class="class-booking-header">
  <h1 class="title is-3">Agenda tus clases</h1>
</div>

<main class="booking-container container">
  <div class="columns is-mobile">
    <section class="column student-info">
      <div class="student-name student-shared-style">
        <h3 *ngIf="userData?.firstName && userData?.lastName">
          {{ userName() }}
        </h3>
      </div>
      <div class="student-row student-shared-style">
        <p class="student-email">{{ userData?.email }}</p>
        <p class="student-stage">{{ userData?.stage?.description }}</p>
      </div>

      <!-- Selected Meetings Section -->
      <div class="student-schedule student-shared-style" *ngIf="meetings.length > 0">
        <h4 class="schedule-title">Agendadas</h4>
        <div class="scroll-buttons">
          <button class="scroll-button left" (click)="scrollLeft()" [class.hidden]="!canScrollLeft" aria-label="Scroll left">
            <i class="fas fa-chevron-left"></i>
          </button>
          <button class="scroll-button right" (click)="scrollRight()" [class.hidden]="!canScrollRight" aria-label="Scroll right">
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>
        <div class="schedule-list" #scheduleList>
          <div *ngFor="let meeting of meetings; let i = index" class="schedule-item" (click)="openMeetingDetailModal(meeting, i)">
            <div class="meeting-title">
              <strong>
                {{ isToday(meeting.date)
                ? 'Hoy' : isTomorrow(meeting.date)
                  ? 'Mañana' : isCurrentWeek(meeting.date)
                    ? capitalizeFirstLetter(meeting.date | date: 'EEEE':'UTC')
                      : (meeting.date | date: 'mediumDate':'UTC') }}
              </strong>
            </div>
            <div class="meeting-info-container">
              <div class="schedule-info">
                <strong>Fecha: </strong> <span>{{ meeting.date | date: 'mediumDate':'UTC' }}</span><br>
                <strong>Hora: </strong> <span>{{ meeting.hour | number: '2.0' }}:00</span>
              </div>
              <div class="schedule-delete">
                <button class="delete-button" *ngIf="canDeleteMeeting(meeting)" (click)="openDeleteModal(meeting); $event.stopPropagation()">
                  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e8eaed">
                    <path d="M280-120q-33 0-56.5-23.5T200-200v-520h-40v-80h200v-40h240v40h200v80h-40v520q0 33-23.5 56.5T680-120H280Zm400-600H280v520h400v-520ZM360-280h80v-360h-80v360Zm160 0h80v-360h-80v360ZM280-720v520-520Z"/>
                  </svg>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- No Meetings Message -->
      <div class="no-meeting" *ngIf="meetings.length === 0">
        <p>No tienes fechas de clases programadas</p>
        <i class="far fa-calendar-times no-meeting-icon"></i>
      </div>
    </section>
  </div>

  <!-- Date and Time Selection Section -->
  <div class="date-time-scroll-container">
    <div class="date-time-wrapper">
      
      <!-- Calendar Selection -->
      <app-meeting-calendar
        [disabledDates]="disabledDates"
        [disabledDatesAndHours]="disabledDatesAndHours"
        [isScheduleEnabled]="isScheduleEnabled"
        [resetSelectionTrigger]="resetCalendarSelectionTrigger"
        (daySelected)="onDaySelected($event)"
      ></app-meeting-calendar>

      <!-- Time Slots -->
      <app-meeting-time-slots
        [selectedDayInfo]="selectedDay !== null ? { year: selectedYear, month: monthNumber, day: selectedDay } : null"
        [disabledDatesAndHours]="disabledDatesAndHours"
        [ecuadorTime]="ecuadorTime"
        (timeSlotSelected)="selectTimeSlot($event)">
      </app-meeting-time-slots>

      <!-- clases agendadas -->
      <section class="scheduled-meetings shared-box-style" *ngIf="meetings.length > 0">
        <h2 class="title-date">Agendadas</h2>
        <div class="meetings-list-scroll">
          <div
            *ngFor="let meeting of meetings; let i = index"
            class="meeting-card"
            (click)="openMeetingDetailModal(meeting, i)"
          >
            <div class="meeting-card-header">
              <i class="fas fa-calendar-alt calendar-icon"></i>
              <div class="meeting-date-title">
                <strong>
                  {{
                    isToday(meeting.date)
                      ? 'Hoy'
                      : isTomorrow(meeting.date)
                      ? 'Mañana'
                      : isCurrentWeek(meeting.date)
                      ? capitalizeFirstLetter(meeting.date | date: 'EEEE':'UTC')
                      : (meeting.date | date: 'mediumDate':'UTC')
                  }}
                </strong>
              </div>
              <button
                *ngIf="canDeleteMeeting(meeting)"
                class="delete-button"
                (click)="openDeleteModal(meeting); $event.stopPropagation()"
              >
                <i class="fas fa-trash-alt"></i>
              </button>
            </div>
            <div class="meeting-card-body">
              <p><strong>Fecha:</strong> {{ meeting.date | date: 'mediumDate':'UTC' }}</p>
              <p><strong>Hora:</strong> {{ meeting.hour }}:00</p>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>
</main>

<!-- Modal de detalles de la reunión -->
<div class="modal" [ngClass]="{ 'is-active': isMeetingDetailModalActive }">
  <div class="modal-background" (click)="closeMeetingDetailModal()"></div>
  <div class="modal-card meeting-detail-modal">

    <header class="modal-card-head">
      <p class="modal-card-title">Detalles Reunion Agendada</p>
    </header>

    <section class="modal-card-body">

      <p><strong>Fecha:</strong> <span>{{ selectedMeeting?.date | date: 'EEEE, d MMMM YYYY':'UTC' }}</span></p>

      <p class="meeting-hour-inline">
        <strong>Hora:</strong>
        <span class="main-hour">
          {{ selectedMeeting?.hour }}:00
        </span>
      </p>

      <ng-container *ngIf="selectedMeeting?.localhour !== selectedMeeting?.hour">
        <p class="meeting-hour-inline">
          <strong>Hora Ecuador:</strong>
          <ng-container *ngIf="selectedMeeting?.localdate !== selectedMeeting?.date">
            <span class="secondary-hour">
              {{ selectedMeeting?.localdate | date: 'EEEE, d MMMM yyyy':'UTC' }}, {{ selectedMeeting?.localhour }}:00
            </span>
          </ng-container>
          <ng-container *ngIf="selectedMeeting?.localdate === selectedMeeting?.date">
            <span class="secondary-hour">
              {{ selectedMeeting?.localhour }}:00
            </span>
          </ng-container>
        </p>
      </ng-container>

      <p><strong>Modo:</strong> <span>{{ selectedMeeting?.mode === mode.ONLINE ? 'Online' : 'Presencial' }}</span></p>
      <p>
        <strong>Instructor:</strong>
        <span>
          {{ (selectedMeeting?.instructor?.user?.firstName || 'No asignado') | titlecase }}
          {{ selectedMeeting?.instructor?.user?.lastName | titlecase }}
        </span>
      </p>
      <p *ngIf="selectedMeeting?.password && linkStatus === 'clickable' && selectedMeeting?.mode === mode.ONLINE">
        <strong>Contraseña:</strong>
        <span>{{ selectedMeeting?.password }}</span>
      </p>

      <ng-container *ngIf="selectedMeeting?.mode === mode.ONLINE">
        <p class="meeting-link"
           [class.no-link]="!selectedMeeting?.link"
           [class.clickable]="linkStatus === 'clickable'"
           [class.not-clickable]="linkStatus === 'not-clickable'"
           [class.not-available]="linkStatus === 'not-available'">

          <ng-container [ngSwitch]="linkStatus">
            <a *ngSwitchCase="'clickable'"
               (click)="handleMeetingAssistanceClick(selectedMeeting?.id)"
               [href]="getFormattedLink(selectedMeeting?.link)"
               target="_blank"
               rel="noopener noreferrer"
               style="user-select: none;">
              Ir a la clase
            </a>

            <span *ngSwitchCase="'not-clickable'"
                role="link"
                aria-disabled="true">
                {{ getMeetingLinkMessage() }}
            </span>

            <span *ngSwitchCase="'not-available'"
                  role="link"
                  aria-disabled="true">
              Enlace no disponible
            </span>
          </ng-container>
        </p>

        <p class="link-note" *ngIf="selectedMeeting?.link">
          <small>
            El enlace estará disponible 5 minutos antes y hasta 6 minutos después de la hora agendada.
          </small>
        </p>
      </ng-container>

    </section>
  </div>
</div>


<!-- Modal exitoso con botones para confirmar o cancelar -->
<div *ngIf="showSuccessModal" class="modal-overlay">
  <div class="modal-content success-modal">
    <i class="fas fa-question-circle question-icon"></i>

    <p *ngIf="localdateSelected">
      Usted ha seleccionado<br />
      {{ getFormattedLocalSelection() }}
    </p>

    <p class="radio-question">Elige modo de la clase:</p>

    <div class="radio-options">
      <label class="custom-radio">
        <input type="radio" name="meetingType" [(ngModel)]="meetingType" [value]="mode.ONLINE" checked>
        <span class="radio-label">Online</span>
      </label>
      <label class="custom-radio">
        <input type="radio" name="meetingType" [(ngModel)]="meetingType" [value]="mode.PRESENCIAL">
        <span class="radio-label">Presencial</span>
      </label>
    </div>

    <div class="modal-buttons">
      <button class="button is-success" (click)="bookMeeting()">Aceptar</button>
      <button class="button is-danger" (click)="cancelSelection()">Cancelar</button>
    </div>
  </div>
</div>

<app-modal
  [showModal]="modalConfig.show"
  [message]="modalConfig.message"
  [isError]="modalConfig.isError"
  [isSuccess]="modalConfig.isSuccess"
  [isInfo]="modalConfig.isInfo"
  [showButtons]="modalConfig.confirm !== undefined"
  (confirmAction)="modalConfig.confirm && modalConfig.confirm()"
  (close)="modalConfig.close()">
</app-modal>
