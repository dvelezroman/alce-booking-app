<div class="class-booking-header">
  <h1 class="title is-3">Clases Agendadas</h1>
</div>

<div class="view-toggle-buttons">
  <button
    class="button is-info is-light"
    [class.is-active]="viewMode === 'calendar'"
    (click)="setViewMode('calendar')">
    Ver Calendario
  </button>

  <button
    class="button is-success is-light"
    [class.is-active]="viewMode === 'range'"
    (click)="setViewMode('range')">
    Buscar por Rango
  </button>
</div>

<div *ngIf="viewMode === 'calendar'">
  <div class="calendar-hint">
    <p>Selecciona un día en el calendario para ver la fecha y hora de tu clase asignada.</p>
  </div>

  <div class="legend-wrapper">
    <div class="calendar-legend">
      <div class="legend-item">
        <span class="legend-dot"></span>
        <span class="legend-text">Día con clases programadas</span>
      </div>
    </div>
  </div>

  <section class="date-time-selection shared-box-style">
    <div class="month-selector">
      <button *ngIf="selectedMonth !== minMonth || selectedYear !== minYear"
              class="button is-small prev-button"
              (click)="prevMonth()"
              aria-label="Mes anterior">
        <i class="fas fa-chevron-left"></i>
      </button>

      <span class="month-label">{{ selectedMonth }} {{ selectedYear }}</span>

      <button *ngIf="selectedMonth !== maxMonth || selectedYear !== maxYear"
              class="button is-small next-button"
              (click)="nextMonth()"
              aria-label="Mes siguiente">
        <i class="fas fa-chevron-right"></i>
      </button>
    </div>

    <div class="calendar">
      <div class="calendar-header">
        <div class="calendar-day-header">D</div>
        <div class="calendar-day-header">L</div>
        <div class="calendar-day-header">M</div>
        <div class="calendar-day-header">M</div>
        <div class="calendar-day-header">J</div>
        <div class="calendar-day-header">V</div>
        <div class="calendar-day-header">S</div>
      </div>

      <div class="calendar-grid">
        <div
          *ngFor="let day of currentMonthDays"
          class="calendar-day"
          [ngClass]="{
            'empty': day.day === '',
            'selected': selectedDay === day.day,
            'has-meeting': day.hasMeeting,
            'past-meeting': day.isPast
          }"
          (click)="showMeetingsOfDay(day)"
        >
          {{ day.day }}
        </div>
      </div>
    </div>
  </section>
</div>

<!-- meetings por rango de fechas -->
<div *ngIf="viewMode === 'range'" class="date-range-search">
  <div class="calendar-hint-range">
    <p>Consulta tus clases por rango de fechas.</p>
  </div>

  <div class="date-inputs">
    <div>
      <label for="fromDate">Desde:</label>
      <input
        type="date"
        id="fromDate"
        [(ngModel)]="rangeFrom"
        [ngClass]="{ 'error-border': rangeError.from }"
      />
      <small *ngIf="rangeError.from" class="error-text">Requerido</small>
    </div>

    <div>
      <label for="toDate">Hasta:</label>
      <input
        type="date"
        id="toDate"
        [(ngModel)]="rangeTo"
        [ngClass]="{ 'error-border': rangeError.to }"
      />
      <small *ngIf="rangeError.to" class="error-text">Requerido</small>
    </div>
  </div>

  <button class="button is-small is-link" (click)="searchMeetingsByRange()">Buscar</button>
</div>
  
  <!-- Tabla de resultados -->
<div *ngIf="meetingsOfDay.length === 0 && selectedDay !== null" class="no-meetings-message">
  <p>No hay clases programadas para este día.</p>
</div>
<div *ngIf="meetingsOfDay.length > 0" class="meeting-results">
  <h3 *ngIf="viewMode === 'calendar'" class="title is-5">
    Clases para el {{ getFormattedSelectedDate() }}
  </h3>

  <div class="table-responsive">
    <table class="table is-fullwidth table-scroll-fixed">
      <thead>
        <tr>
          <th>Stage</th>
          <th>Fecha</th>
          <th>Hora</th>
          <th *ngIf="showEcuadorHourColumn">Fecha Ecuador</th>
          <th>Estado</th>
          <th>Modalidad</th>
          <th>Contenido</th>
          <th>Asistencia</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let item of meetingsOfDay">
          <td>{{ item.stage?.number || 'Sin etapa' }}</td>
          <td>{{ getUtcFormattedDate(item.date) }}</td>
          <td>{{ get24HourFormat(item.date) }}</td>
          <td *ngIf="showEcuadorHourColumn">
            <ng-container *ngIf="item.date !== item.localdate; else noEcuadorHour">
              <div>{{ getUtcFormattedDate(item.localdate) }}</div>
              <div>{{ get24HourFormat(item.localdate) }}</div>
            </ng-container>
            <ng-template #noEcuadorHour>-</ng-template>
          </td>
          <td>{{ item.status }}</td>
          <td>{{ item.mode || 'Sin modalidad' }}</td>
          <td>{{ getMeetingThemeDescription(item.meetingTheme) }}</td>
          <td>
            <ng-container *ngIf="isPastMeeting(item.date); else upcoming">
              <span [ngClass]="{ 'has-text-success': item.markAssistanceAt, 'has-text-danger': !item.markAssistanceAt }">
                {{ item.markAssistanceAt ? 'Asistió' : 'No asistió' }}
              </span>
            </ng-container>
            <ng-template #upcoming>
              -
            </ng-template>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>
